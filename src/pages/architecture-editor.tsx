import React, { useCallback, useState } from 'react';
import {
  ReactFlow,
  addEdge,
  MiniMap,
  Controls,
  Background,
  useNodesState,
  useEdgesState,
  Connection,
  Edge,
  Node,
  NodeTypes,
} from '@xyflow/react';
import '@xyflow/react/dist/style.css';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Plus, Settings, Save, Download, Upload } from 'lucide-react';

// Ê®°ÁµÑÈ°ûÂûãÂÆöÁæ©
interface ModuleData extends Record<string, unknown> {
  id: string;
  label: string;
  type: 'model' | 'tool' | 'core-ai' | 'service' | 'data-store' | 'interface';
  status: 'completed' | 'built-in' | 'downloadable' | 'in-progress';
  description: string;
  location?: string;
}

// Ëá™ÂÆöÁæ©ÁØÄÈªûÁµÑ‰ª∂
const ModuleNode: React.FC<{ data: ModuleData }> = ({ data }) => {
  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-500';
      case 'built-in': return 'bg-blue-500';
      case 'downloadable': return 'bg-orange-500';
      case 'in-progress': return 'bg-yellow-500';
      default: return 'bg-gray-500';
    }
  };

  const getTypeIcon = (type: string) => {
    switch (type) {
      case 'model': return 'ü§ñ';
      case 'tool': return 'üîß';
      case 'core-ai': return 'üß†';
      case 'service': return '‚öôÔ∏è';
      case 'data-store': return 'üíæ';
      case 'interface': return 'üñ•Ô∏è';
      default: return 'üì¶';
    }
  };

  return (
    <Card className="min-w-[200px] shadow-lg">
      <CardHeader className="pb-2">
        <div className="flex items-center gap-2">
          <span className="text-xl">{getTypeIcon(data.type)}</span>
          <CardTitle className="text-sm">{data.label}</CardTitle>
          <Badge className={`${getStatusColor(data.status)} text-white text-xs`}>
            {data.status}
          </Badge>
        </div>
      </CardHeader>
      <CardContent>
        <p className="text-xs text-muted-foreground">{data.description}</p>
        {data.location && (
          <p className="text-xs text-blue-600 mt-1">{data.location}</p>
        )}
      </CardContent>
    </Card>
  );
};

// ÂàùÂßãÁØÄÈªûÊï∏Êìö
const initialNodes: Node[] = [
  // Models
  {
    id: 'math-model',
    type: 'module',
    position: { x: 100, y: 100 },
    data: {
      id: 'math-model',
      label: 'Math Model',
      type: 'model',
      status: 'built-in',
      description: 'Lightweight model for basic arithmetic problems',
      location: 'src/tools/math_model/'
    }
  },
  {
    id: 'logic-model',
    type: 'module',
    position: { x: 300, y: 100 },
    data: {
      id: 'logic-model',
      label: 'Logic Model',
      type: 'model',
      status: 'built-in',
      description: 'Lightweight model for basic logic problems',
      location: 'src/tools/logic_model/'
    }
  },
  {
    id: 'image-recognition-model',
    type: 'module',
    position: { x: 500, y: 100 },
    data: {
      id: 'image-recognition-model',
      label: 'Image Recognition Model',
      type: 'model',
      status: 'downloadable',
      description: 'Image recognition using template matching',
      location: 'src/tools/image_recognition_tool.py'
    }
  },
  // Tools
  {
    id: 'math-tool',
    type: 'module',
    position: { x: 100, y: 300 },
    data: {
      id: 'math-tool',
      label: 'Math Tool',
      type: 'tool',
      status: 'completed',
      description: 'Tool for basic arithmetic problems',
      location: 'src/tools/math_tool.py'
    }
  },
  {
    id: 'calculator-tool',
    type: 'module',
    position: { x: 300, y: 300 },
    data: {
      id: 'calculator-tool',
      label: 'Calculator Tool',
      type: 'tool',
      status: 'completed',
      description: 'Calculate mathematical expressions',
      location: 'src/tools/calculator_tool.py'
    }
  },
  // Core AI
  {
    id: 'dialogue-manager',
    type: 'module',
    position: { x: 100, y: 500 },
    data: {
      id: 'dialogue-manager',
      label: 'Dialogue Manager',
      type: 'core-ai',
      status: 'completed',
      description: 'Manages AI conversations and responses'
    }
  },
  {
    id: 'learning-manager',
    type: 'module',
    position: { x: 300, y: 500 },
    data: {
      id: 'learning-manager',
      label: 'Learning Manager',
      type: 'core-ai',
      status: 'completed',
      description: 'Handles learning and adaptation'
    }
  },
  {
    id: 'ham-memory',
    type: 'module',
    position: { x: 500, y: 500 },
    data: {
      id: 'ham-memory',
      label: 'HAM Memory Manager',
      type: 'core-ai',
      status: 'completed',
      description: 'Hierarchical memory management system'
    }
  },
  {
    id: 'tool-dispatcher',
    type: 'module',
    position: { x: 700, y: 500 },
    data: {
      id: 'tool-dispatcher',
      label: 'Tool Dispatcher',
      type: 'core-ai',
      status: 'completed',
      description: 'Routes and executes tool requests'
    }
  },
  // Services
  {
    id: 'main-api-server',
    type: 'module',
    position: { x: 100, y: 700 },
    data: {
      id: 'main-api-server',
      label: 'Main API Server',
      type: 'service',
      status: 'completed',
      description: 'FastAPI backend server'
    }
  },
  {
    id: 'llm-interface',
    type: 'module',
    position: { x: 300, y: 700 },
    data: {
      id: 'llm-interface',
      label: 'LLM Interface',
      type: 'service',
      status: 'completed',
      description: 'Interface to language models'
    }
  },
  // Interfaces
  {
    id: 'cli-interface',
    type: 'module',
    position: { x: 100, y: 900 },
    data: {
      id: 'cli-interface',
      label: 'CLI Interface',
      type: 'interface',
      status: 'completed',
      description: 'Command line interface'
    }
  },
  {
    id: 'electron-app',
    type: 'module',
    position: { x: 300, y: 900 },
    data: {
      id: 'electron-app',
      label: 'Electron App',
      type: 'interface',
      status: 'completed',
      description: 'Desktop application interface'
    }
  }
];

// ÂàùÂßãÈÄ£Êé•Á∑ö
const initialEdges: Edge[] = [
  // Tools connect to models
  { id: 'e1', source: 'math-tool', target: 'math-model', type: 'smoothstep' },
  { id: 'e2', source: 'calculator-tool', target: 'math-model', type: 'smoothstep' },
  
  // Core AI connections
  { id: 'e3', source: 'dialogue-manager', target: 'learning-manager', type: 'smoothstep' },
  { id: 'e4', source: 'dialogue-manager', target: 'ham-memory', type: 'smoothstep' },
  { id: 'e5', source: 'dialogue-manager', target: 'tool-dispatcher', type: 'smoothstep' },
  { id: 'e6', source: 'tool-dispatcher', target: 'math-tool', type: 'smoothstep' },
  { id: 'e7', source: 'tool-dispatcher', target: 'calculator-tool', type: 'smoothstep' },
  
  // Services connect to core AI
  { id: 'e8', source: 'main-api-server', target: 'dialogue-manager', type: 'smoothstep' },
  { id: 'e9', source: 'llm-interface', target: 'dialogue-manager', type: 'smoothstep' },
  
  // Interfaces connect to services
  { id: 'e10', source: 'cli-interface', target: 'main-api-server', type: 'smoothstep' },
  { id: 'e11', source: 'electron-app', target: 'main-api-server', type: 'smoothstep' }
];

const nodeTypes: NodeTypes = {
  module: ModuleNode,
};

export default function ArchitectureEditor() {
  const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
  const [edges, setEdges, onEdgesChange] = useEdgesState(initialEdges);
  const [editingNode, setEditingNode] = useState<ModuleData | null>(null);
  const [isAddDialogOpen, setIsAddDialogOpen] = useState(false);

  const onConnect = useCallback(
    (params: Connection) => setEdges((eds) => addEdge(params, eds)),
    [setEdges],
  );

  const addNewModule = () => {
    const newNode: Node = {
      id: `module-${Date.now()}`,
      type: 'module',
      position: { x: Math.random() * 500, y: Math.random() * 500 },
      data: {
        id: `module-${Date.now()}`,
        label: 'New Module',
        type: 'tool',
        status: 'in-progress',
        description: 'New module description'
      }
    };
    setNodes((nds) => [...nds, newNode]);
    setIsAddDialogOpen(false);
  };

  const editModule = (moduleData: ModuleData) => {
    setEditingNode(moduleData);
  };

  const saveModule = (updatedData: ModuleData) => {
    setNodes((nds) =>
      nds.map((node) =>
        node.id === updatedData.id
          ? { ...node, data: updatedData }
          : node
      )
    );
    setEditingNode(null);
  };

  return (
    <div className="h-full w-full flex flex-col">
      {/* Â∑•ÂÖ∑Ê¨Ñ */}
      <div className="flex items-center gap-2 p-4 border-b bg-background">
        <Button onClick={() => setIsAddDialogOpen(true)} size="sm">
          <Plus className="w-4 h-4 mr-2" />
          Ê∑ªÂä†Ê®°ÁµÑ
        </Button>
        <Button variant="outline" size="sm">
          <Save className="w-4 h-4 mr-2" />
          ‰øùÂ≠ò
        </Button>
        <Button variant="outline" size="sm">
          <Download className="w-4 h-4 mr-2" />
          Â∞éÂá∫
        </Button>
        <Button variant="outline" size="sm">
          <Upload className="w-4 h-4 mr-2" />
          Â∞éÂÖ•
        </Button>
      </div>

      {/* React Flow Á∑®ËºØÂô® */}
      <div className="flex-1">
        <ReactFlow
          nodes={nodes}
          edges={edges}
          onNodesChange={onNodesChange}
          onEdgesChange={onEdgesChange}
          onConnect={onConnect}
          nodeTypes={nodeTypes}
          fitView
          onNodeDoubleClick={(_, node) => editModule(node.data as ModuleData)}
        >
          <Controls />
          <MiniMap />
          <Background />
        </ReactFlow>
      </div>

      {/* Ê∑ªÂä†Ê®°ÁµÑÂ∞çË©±Ê°Ü */}
      <Dialog open={isAddDialogOpen} onOpenChange={setIsAddDialogOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Ê∑ªÂä†Êñ∞Ê®°ÁµÑ</DialogTitle>
          </DialogHeader>
          <div className="grid gap-4 py-4">
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="name" className="text-right">ÂêçÁ®±</Label>
              <Input id="name" placeholder="Ê®°ÁµÑÂêçÁ®±" className="col-span-3" />
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="type" className="text-right">È°ûÂûã</Label>
              <Select>
                <SelectTrigger className="col-span-3">
                  <SelectValue placeholder="ÈÅ∏ÊìáÊ®°ÁµÑÈ°ûÂûã" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="model">Ê®°Âûã</SelectItem>
                  <SelectItem value="tool">Â∑•ÂÖ∑</SelectItem>
                  <SelectItem value="core-ai">Ê†∏ÂøÉAI</SelectItem>
                  <SelectItem value="service">ÊúçÂãô</SelectItem>
                  <SelectItem value="data-store">Êï∏ÊìöÂ≠òÂÑ≤</SelectItem>
                  <SelectItem value="interface">‰ªãÈù¢</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="grid grid-cols-4 items-center gap-4">
              <Label htmlFor="description" className="text-right">ÊèèËø∞</Label>
              <Textarea id="description" placeholder="Ê®°ÁµÑÊèèËø∞" className="col-span-3" />
            </div>
          </div>
          <div className="flex justify-end gap-2">
            <Button variant="outline" onClick={() => setIsAddDialogOpen(false)}>
              ÂèñÊ∂à
            </Button>
            <Button onClick={addNewModule}>Ê∑ªÂä†</Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* Á∑®ËºØÊ®°ÁµÑÂ∞çË©±Ê°Ü */}
      {editingNode && (
        <Dialog open={!!editingNode} onOpenChange={() => setEditingNode(null)}>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Á∑®ËºØÊ®°ÁµÑ: {editingNode.label}</DialogTitle>
            </DialogHeader>
            <div className="grid gap-4 py-4">
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="edit-name" className="text-right">ÂêçÁ®±</Label>
                <Input 
                  id="edit-name" 
                  value={editingNode.label} 
                  onChange={(e) => setEditingNode({...editingNode, label: e.target.value})}
                  className="col-span-3" 
                />
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="edit-type" className="text-right">È°ûÂûã</Label>
                <Select value={editingNode.type} onValueChange={(value) => setEditingNode({...editingNode, type: value as any})}>
                  <SelectTrigger className="col-span-3">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="model">Ê®°Âûã</SelectItem>
                    <SelectItem value="tool">Â∑•ÂÖ∑</SelectItem>
                    <SelectItem value="core-ai">Ê†∏ÂøÉAI</SelectItem>
                    <SelectItem value="service">ÊúçÂãô</SelectItem>
                    <SelectItem value="data-store">Êï∏ÊìöÂ≠òÂÑ≤</SelectItem>
                    <SelectItem value="interface">‰ªãÈù¢</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="edit-status" className="text-right">ÁãÄÊÖã</Label>
                <Select value={editingNode.status} onValueChange={(value) => setEditingNode({...editingNode, status: value as any})}>
                  <SelectTrigger className="col-span-3">
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="completed">Â∑≤ÂÆåÊàê</SelectItem>
                    <SelectItem value="built-in">ÂÖßÂª∫</SelectItem>
                    <SelectItem value="downloadable">ÂèØ‰∏ãËºâ</SelectItem>
                    <SelectItem value="in-progress">ÈÄ≤Ë°å‰∏≠</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="edit-description" className="text-right">ÊèèËø∞</Label>
                <Textarea 
                  id="edit-description" 
                  value={editingNode.description} 
                  onChange={(e) => setEditingNode({...editingNode, description: e.target.value})}
                  className="col-span-3" 
                />
              </div>
              <div className="grid grid-cols-4 items-center gap-4">
                <Label htmlFor="edit-location" className="text-right">‰ΩçÁΩÆ</Label>
                <Input 
                  id="edit-location" 
                  value={editingNode.location || ''} 
                  onChange={(e) => setEditingNode({...editingNode, location: e.target.value})}
                  className="col-span-3" 
                />
              </div>
            </div>
            <div className="flex justify-end gap-2">
              <Button variant="outline" onClick={() => setEditingNode(null)}>
                ÂèñÊ∂à
              </Button>
              <Button onClick={() => saveModule(editingNode)}>‰øùÂ≠ò</Button>
            </div>
          </DialogContent>
        </Dialog>
      )}
    </div>
  );
}